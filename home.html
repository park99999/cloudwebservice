<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
        .button-group {
            margin: 10px 0;
            text-align: center;
        }
        .button-group button {
            margin: 5px;
            padding: 3px 5px;
            font-size: 14px;
            cursor: pointer;
        }
        #searchResult {
            margin-top: 20px;
        }
        .result-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result-item h4 {
            margin: 0 0 5px 0;
        }
        .result-item button {
            margin-top: 5px;
            padding: 5px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .result-item button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="button-group">
        <button id="busStopBtn">버스 정류소 위치 조회</button>
        <button id="evStationBtn">전기차 충전소 위치 조회</button>
        <button id="bikeRentalBtn">자전거 대여소 위치 조회</button>
    </div>
    <!-- 지도 표시 -->
    <div id="map"></div>

    <!-- 조회 결과 -->
    <div id="searchResult">
        <h3>조회 결과</h3>
        <div id="resultList"></div>
    </div>

    <!-- 카카오 지도 API -->
    <script 
        type="text/javascript" 
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0aace081d030d026f82d5e78011f64c5&libraries=services"></script>
    
    <script>
        let map;
        let currentLatitude, currentLongitude;

        function initializeMap(latitude, longitude) {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(latitude, longitude),
                level: 4
            };
            map = new kakao.maps.Map(mapContainer, mapOption);
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLatitude = position.coords.latitude;
                        currentLongitude = position.coords.longitude;
                        initializeMap(currentLatitude, currentLongitude);
                    },
                    (error) => {
                        console.error('위치 정보를 가져올 수 없습니다.', error);
                        initializeMap(37.5665, 126.9780); // 서울 중심 좌표
                    }
                );
            } else {
                console.error('브라우저가 위치 정보를 지원하지 않습니다.');
                initializeMap(37.5665, 126.9780);
            }
        }

        async function fetchLocations(type) {
            try {
                const response = await fetch(`https://9240rcurj0.execute-api.ap-northeast-2.amazonaws.com/cloudweb-team02/nearest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        latitude: currentLatitude,
                        longitude: currentLongitude
                    })
                });
                if (!response.ok) throw new Error('조회 실패');
                const data = await response.json();

                if (type === 'bikeRentals') {
                    displayResults(data.nearestBikeStations, '자전거 대여소');
                } else if (type === 'busStops') {
                    displayResults(data.nearestBusStops, '버스 정류소');
                } else if (type === 'evStations') {
                    displayResults(data.nearestChargers, '전기차 충전소');
                }
            } catch (error) {
                console.error('오류 발생:', error);
                alert('위치 정보를 가져오는 데 실패했습니다.');
            }
        }

        function displayResults(locations, type) {
            const resultList = document.getElementById('resultList');
            resultList.innerHTML = '';

            if (locations.length === 0) {
                resultList.innerHTML = '<p>결과가 없습니다.</p>';
                return;
            }

            locations.forEach((location) => {
                const item = document.createElement('div');
                item.className = 'result-item';

                if (type === '자전거 대여소') {
                    item.innerHTML = `
                        <h4>${type}</h4>
                        <p>${location.station_name || '이름 없음'}</p>
                        <button onclick="goToReview('${location.place_id}', '${location.station_name}')">리뷰 보기</button>
                    `;
                } else if (type === '버스 정류소') {
                    item.innerHTML = `
                        <h4>${type}</h4>
                        <p>${location.name || '이름 없음'}</p>
                        <button onclick="goToReview('${location.place_id}', '${location.name}')">리뷰 보기</button>
                    `;
                } else if (type === '전기차 충전소') {
                    item.innerHTML = `
                        <h4>${type}</h4>
                        <p>${location.station_name || '이름 없음'}</p>
                        <button onclick="goToReview('${location.place_id}', '${location.station_name}')">리뷰 보기</button>
                    `;
                }

                resultList.appendChild(item);

                const markerPosition = new kakao.maps.LatLng(location.latitude || location.lat, location.longitude || location.lon);
                const marker = new kakao.maps.Marker({
                    position: markerPosition,
                    map: map
                });

                const infoWindow = new kakao.maps.InfoWindow({
                    content: `<div style="padding:5px;">${location.station_name || location.name || '이름 없음'}</div>`
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    infoWindow.open(map, marker);
                });
            });
        }

        function goToReview(placeId, name) {
            const url = `/reviewwrite.html?placeId=${placeId}&name=${encodeURIComponent(name)}`;
            window.location.href = url;
        }

        document.getElementById('busStopBtn').addEventListener('click', () => fetchLocations('busStops'));
        document.getElementById('evStationBtn').addEventListener('click', () => fetchLocations('evStations'));
        document.getElementById('bikeRentalBtn').addEventListener('click', () => fetchLocations('bikeRentals'));

        getCurrentLocation();
    </script>
</body>
</html>
