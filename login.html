<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 완료</title>
</head>
<body>
    <h1>로그인 완료</h1>
    
    <!-- 로그인된 사용자 정보 표시 -->
    <div id="user-info">
        <p><strong>사용자 이름:</strong> <span id="username"></span></p>
        <p><strong>이메일:</strong> <span id="email"></span></p>
        <p><strong>사용자 풀 ID:</strong> <span id="user-pool-id"></span></p>
    </div>

    <!-- 로그아웃 버튼 -->
    <button id="logout-btn">로그아웃</button>

    <script>
        // Authorization Code를 URL에서 추출
        const code = new URLSearchParams(window.location.search).get('code');
        
        if (!code) {
            alert('로그인 실패: 인증 코드가 없습니다.');
            window.location.href = 'login.html';  // 로그인 페이지로 리다이렉션
        }

        // 1. Authorization Code로 Access Token 요청
        async function exchangeCodeForToken(code) {
            const params = new URLSearchParams();
            params.append('grant_type', 'authorization_code');
            params.append('client_id', '6q9qa6gp5sickhcco2o4v4jups');  // Cognito App Client ID
            params.append('code', code);
            params.append('redirect_uri', 'https://main.drpimn3gaf9hu.amplifyapp.com/login.html');  // 동일한 리다이렉트 URI

            const response = await fetch('https://ap-northeast-2gjabstzt6.auth.ap-northeast-2.amazoncognito.com/oauth2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            });

            if (response.ok) {
                const data = await response.json();
                return data;  // {access_token, id_token, refresh_token, etc.}
            } else {
                console.error('Error exchanging code for token:', response);
                throw new Error('Failed to get token');
            }
        }

        // 2. Access Token을 이용해 사용자 정보 요청
        async function getUserInfo(accessToken) {
            const response = await fetch('https://ap-northeast-2gjabstzt6.auth.ap-northeast-2.amazoncognito.com/oauth2/userInfo', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            if (response.ok) {
                const user = await response.json();
                return user;  // 사용자 정보
            } else {
                console.error('Error fetching user info:', response);
                throw new Error('Failed to fetch user info');
            }
        }

        // 3. 사용자 정보 처리
        exchangeCodeForToken(code)
            .then(data => {
                const accessToken = data.access_token;
                
                // Access Token으로 사용자 정보 가져오기
                return getUserInfo(accessToken);
            })
            .then(user => {
                console.log('사용자 정보:', user);
                document.getElementById('username').textContent = user.username || '정보 없음';
                document.getElementById('email').textContent = user.email || '정보 없음';
                document.getElementById('user-pool-id').textContent = user.userPoolId || '정보 없음';
            })
            .catch(err => {
                console.error('에러 발생:', err);
                alert('로그인 정보 가져오기 실패');
            });

        // 로그아웃 처리
        document.getElementById('logout-btn').addEventListener('click', function() {
            window.location.href = 'https://ap-northeast-2gjabstzt6.auth.ap-northeast-2.amazoncognito.com/logout?client_id=6q9qa6gp5sickhcco2o4v4jups&logout_uri=https://main.drpimn3gaf9hu.amplifyapp.com/logout.html';
        });
    </script>
</body>
</html>